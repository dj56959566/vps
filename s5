#!/bin/bash
# ================================================
# SOCKS5代理脚本更新器
# 版本: 1.0
# ================================================

GREEN="\033[0;32m"
YELLOW="\033[0;33m"
RED="\033[0;31m"
RESET="\033[0m"

WORKDIR="/opt/singbox"
SCRIPT_PATH="/usr/local/bin/singbox_socks5.sh"
BACKUP_PATH="$WORKDIR/singbox_socks5.sh"

echo -e "${GREEN}"
echo -e "  ____  _              ____            "
echo -e " / ___|(_)_ __   __ _ | __ )  _____  __"
echo -e "  \___ \| | '_ \ / _\` ||  _ \ / _ \ \/ /"
echo -e "  ___) | | | | | (_| || |_) | (_) >  < "
echo -e " |____/|_|_| |_|\__, ||____/ \___/_/\_\\"
echo -e "                |___/                  "
echo -e "  SOCKS5 代理脚本更新器 v1.0           "
echo -e "${RESET}"

# 检查是否为root用户
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}错误: 此脚本必须以root用户身份运行${RESET}"
    exit 1
fi

echo -e "${YELLOW}正在检查脚本更新...${RESET}"

# 创建备份
if [ -f "$SCRIPT_PATH" ]; then
    cp "$SCRIPT_PATH" "${SCRIPT_PATH}.bak"
    echo -e "${GREEN}已创建脚本备份: ${SCRIPT_PATH}.bak${RESET}"
else
    echo -e "${YELLOW}主脚本不存在，将检查备份脚本${RESET}"
    if [ -f "$BACKUP_PATH" ]; then
        cp "$BACKUP_PATH" "${BACKUP_PATH}.bak"
        echo -e "${GREEN}已创建备份脚本备份: ${BACKUP_PATH}.bak${RESET}"
        SCRIPT_PATH="$BACKUP_PATH"
    else
        echo -e "${RED}找不到任何脚本，将下载新脚本${RESET}"
    fi
fi

# 从GitHub获取最新版本
echo -e "${GREEN}正在从GitHub下载最新版本...${RESET}"
TEMP_SCRIPT="/tmp/singbox_socks5_new.sh"

if curl -s -o "$TEMP_SCRIPT" https://raw.githubusercontent.com/djkcyl/socks5-script/main/singbox_socks5.sh; then
    # 检查下载是否成功
    if [[ -s "$TEMP_SCRIPT" ]]; then
        # 替换当前脚本
        cat "$TEMP_SCRIPT" > "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
        
        # 更新备份脚本
        mkdir -p $WORKDIR
        cat "$TEMP_SCRIPT" > "$BACKUP_PATH"
        chmod +x "$BACKUP_PATH"
        
        rm -f "$TEMP_SCRIPT"
        echo -e "${GREEN}脚本已更新成功！${RESET}"
        
        # 更新快捷命令
        cat > /usr/bin/s <<'EOF'
#!/bin/bash
# 快捷命令 - SOCKS5代理管理脚本
if [ -f "/usr/local/bin/singbox_socks5.sh" ]; then
    bash "/usr/local/bin/singbox_socks5.sh"
elif [ -f "/opt/singbox/singbox_socks5.sh" ]; then
    bash "/opt/singbox/singbox_socks5.sh"
else
    echo -e "\033[0;31m错误: 找不到SOCKS5管理脚本\033[0m"
    echo -e "\033[0;33m请重新安装脚本\033[0m"
fi
EOF
        chmod +x /usr/bin/s
        
        echo -e "${GREEN}快捷命令已更新${RESET}"
        echo -e "${GREEN}是否要立即运行更新后的脚本? (y/n): ${RESET}"
        read choice
        if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
            bash "$SCRIPT_PATH"
        fi
    else
        echo -e "${RED}下载的脚本内容为空，更新失败${RESET}"
        echo -e "${YELLOW}恢复备份中...${RESET}"
        if [ -f "${SCRIPT_PATH}.bak" ]; then
            cp "${SCRIPT_PATH}.bak" "$SCRIPT_PATH"
        fi
    fi
else
    echo -e "${RED}下载失败，无法连接到GitHub${RESET}"
    echo -e "${YELLOW}您可以手动下载最新版本: https://github.com/djkcyl/socks5-script${RESET}"
fi
